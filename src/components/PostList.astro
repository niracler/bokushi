---
import { getCollection } from "astro:content";
import FormattedDate from "./FormattedDate.astro";

// 使用 Promise.all 并行获取所有集合数据
const [blogPosts, monthlyPosts, tilPosts] = await Promise.all([
    getCollection("blog"),
    getCollection("monthly"),
    getCollection("til"),
]);

const posts = [...blogPosts, ...monthlyPosts, ...tilPosts]
    .filter((post) => !post.data.hidden)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const postsByYear = posts.reduce((acc, post) => {
    const year = String(post.data.pubDate.getFullYear());
    if (!acc.has(year)) {
        acc.set(year, []);
    }
    acc.get(year)?.push(post);
    return acc;
}, new Map<string, typeof posts>());

const groupedPosts = Array.from(postsByYear.entries());
---

<section class="section-stack">
	<div class="flex items-center justify-end">
		<label class="inline-flex select-none items-center gap-2 text-sm text-muted">
			<input
				id="filter-deepsearch"
				type="checkbox"
				class="h-4 w-4 accent-[var(--color-accent)]"
				checked
			/>
			<span>隐藏 DeepSearch 文章</span>
		</label>
	</div>
	{
		groupedPosts.map(([year, yearPosts]) => (
			<div class="space-y-4" data-year-group>
				{/* 年份标题 - 使用分隔线而非巨大数字 */}
				<div class="flex items-center gap-4">
					<h3 class="text-xl font-bold tracking-tight text-primary sm:text-2xl">
						{year}
					</h3>
					<div class="h-px flex-1 bg-border-soft" />
				</div>

				<ul class="m-0 flex list-none flex-col gap-0 p-0">
					{yearPosts.map((post) => {
						const isDeepSearch = post.data.tags?.includes('DeepSearch') ?? false;
						return (
							<li data-deepsearch={isDeepSearch ? 'true' : 'false'}>
								<div class="post-link group relative flex items-baseline gap-4 rounded-md px-4 py-2.5 transition-all duration-200 hover:bg-accent-tint-6">
									<h4 class="title flex-1 text-base font-medium tracking-tight text-primary transition-colors duration-200 group-hover:text-accent sm:text-lg">
										<a
											href={`/${post.id}`}
											class="no-underline text-primary hover:text-accent focus-accent"
											data-post-id={post.id}
										>
											{post.data.title}
										</a>
									</h4>

									<p class="date ml-auto shrink-0 text-[0.7rem] font-medium uppercase tracking-[0.12em] text-muted transition-colors duration-200 group-hover:text-accent sm:text-xs" data-no-preview>
										<FormattedDate date={post.data.pubDate} />
									</p>
								</div>
							</li>
						);
					})}
				</ul>
			</div>
		))
	}
</section>

<script is:inline>
	document.addEventListener('DOMContentLoaded', function() {
		const yearGroups = document.querySelectorAll('[data-year-group]');
		const filterCheckbox = document.getElementById('filter-deepsearch');

		if (!filterCheckbox) return;

		const FILTER_KEY = 'hide-deepsearch-posts';
		const savedPreference = window.localStorage.getItem(FILTER_KEY);
		if (savedPreference !== null) {
			filterCheckbox.checked = savedPreference === 'true';
		}

		const applyFilter = () => {
			const hideDeepSearch = filterCheckbox.checked;
			window.localStorage.setItem(FILTER_KEY, String(hideDeepSearch));

			yearGroups.forEach((group) => {
				let visibleCount = 0;
				group.querySelectorAll('li[data-deepsearch]').forEach((item) => {
					const isDeepSearch = item.getAttribute('data-deepsearch') === 'true';
					const shouldHide = hideDeepSearch && isDeepSearch;
					item.style.display = shouldHide ? 'none' : '';
					if (!shouldHide) visibleCount += 1;
				});

				const noDataIndicator = group.querySelector('.no-posts');
				if (noDataIndicator) {
					noDataIndicator.style.display = visibleCount === 0 ? 'block' : 'none';
				} else if (visibleCount === 0) {
					const emptyState = document.createElement('p');
					emptyState.className = 'no-posts text-sm text-[color-mix(in srgb, var(--color-text-muted) 70%, transparent)] italic';
					emptyState.textContent = '（暂无符合条件的文章）';
					group.querySelector('ul')?.appendChild(emptyState);
				}
			});
		};

		filterCheckbox.addEventListener('change', applyFilter);
		applyFilter();
	});
</script>
