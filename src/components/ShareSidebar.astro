---
// ShareSidebar.astro - Fixed sidebar for social sharing
// Follows Vercel Design Guidelines: keyboard accessible, focus visible, 44px touch targets
import { Icon } from "astro-icon/components";

interface Props {
    title: string;
    description?: string;
    tags?: string[];
    url?: string;
    slug: string;
}

const { title, description, tags = [], url = Astro.url.href, slug } = Astro.props;

// Twitter: hashtags as comma-separated (without #), max 3 tags
const twitterHashtags = tags.slice(0, 3).join(",");

// Twitter: truncate description to fit 280 char limit (title + desc + url ~23 + hashtags)
const maxDescLength = 150;
const truncatedDesc =
    description && description.length > maxDescLength
        ? `${description.slice(0, maxDescLength)}...`
        : description;

// Twitter text: title + truncated description
const twitterTextParts = [title];
if (truncatedDesc) twitterTextParts.push(truncatedDesc);
const twitterText = twitterTextParts.join("\n\n");

// Build Twitter URL with hashtags and via parameters
const twitterParams = new URLSearchParams({
    text: twitterText,
    url: url,
    via: "nini38324",
});
if (twitterHashtags) twitterParams.set("hashtags", twitterHashtags);

// Telegram: full text with hashtags
const hashtagsText = tags
    .slice(0, 3)
    .map((t) => `#${t}`)
    .join(" ");
const telegramTextParts = [title];
if (description) telegramTextParts.push(description);
if (hashtagsText) telegramTextParts.push(hashtagsText);
const telegramText = `\n${telegramTextParts.join("\n\n")}`;
const encodedTelegramText = encodeURIComponent(telegramText);
const encodedUrl = encodeURIComponent(url);

const shareLinks = [
    {
        name: "Twitter",
        label: "分享到 Twitter",
        icon: "ri:twitter-fill",
        href: `https://twitter.com/intent/tweet?${twitterParams.toString()}`,
    },
    {
        name: "Telegram",
        label: "分享到 Telegram",
        icon: "ri:telegram-fill",
        href: `https://t.me/share/url?url=${encodedUrl}&text=${encodedTelegramText}`,
    },
];
---

<!-- Desktop: Fixed sidebar on left (symmetric to TOC on right) -->
<aside
    data-share-sidebar
    class="hidden min-[900px]:flex fixed flex-col gap-3 opacity-0 transition-opacity duration-200 mt-[5px]"
    style="right: calc(50% + 25rem + 2rem); top: 6rem;"
    aria-label="分享文章"
>
    {shareLinks.map((link) => (
        <a
            href={link.href}
            target="_blank"
            rel="noopener noreferrer"
            class="flex h-11 w-11 items-center justify-center rounded-full border border-border bg-surface shadow-sm transition-all hover:border-accent hover:text-accent hover:shadow-md focus-accent"
            aria-label={link.label}
        >
            <Icon name={link.icon} class="h-6 w-6" aria-hidden="true" />
        </a>
    ))}
    <button
        type="button"
        class="flex h-11 w-11 items-center justify-center rounded-full border border-border bg-surface shadow-sm transition-all hover:border-accent hover:text-accent hover:shadow-md focus-accent"
        aria-label="复制链接"
        data-copy-link
        data-url={url}
    >
        <Icon name="ri:link" class="h-6 w-6" aria-hidden="true" />
    </button>
    <!-- 点赞按钮 -->
    <button
        type="button"
        class="relative flex h-11 w-11 items-center justify-center rounded-full border border-border bg-surface shadow-sm transition-all hover:border-accent hover:shadow-md focus-accent group"
        aria-label="点赞"
        data-like-button
        data-slug={slug}
    >
        <Icon name="ri:heart-line" class="h-6 w-6 group-data-[liked]:hidden" aria-hidden="true" />
        <Icon name="ri:heart-fill" class="h-6 w-6 hidden group-data-[liked]:block text-red-500" aria-hidden="true" />
        <span
            class="absolute -bottom-1 -right-1 min-w-5 h-5 flex items-center justify-center rounded-full bg-surface border border-border text-xs text-muted"
            data-like-count
        ></span>
    </button>
</aside>

<!-- Mobile: Floating action button that opens share menu -->
<div class="min-[900px]:hidden">
    <!-- Floating trigger button -->
    <button
        type="button"
        data-share-mobile-toggle
        class="fixed bottom-24 right-6 z-40 flex h-14 w-14 items-center justify-center rounded-full backdrop-blur-md bg-[rgba(100,149,237,0.85)] border border-[rgba(255,255,255,0.3)] text-white shadow-[0_8px_32px_rgba(100,149,237,0.35)] transition-all duration-300 hover:scale-105 hover:bg-[rgba(100,149,237,0.95)] hover:shadow-[0_12px_40px_rgba(100,149,237,0.45)] active:scale-95"
        aria-label="分享文章"
        aria-expanded="false"
    >
        <Icon name="ri:share-line" class="h-6 w-6" aria-hidden="true" />
    </button>

    <!-- Share menu (hidden by default) -->
    <div
        data-share-menu
        class="fixed bottom-24 right-6 z-40 flex flex-col-reverse gap-2 pb-16 opacity-0 pointer-events-none transition-opacity duration-200"
        aria-hidden="true"
    >
        {shareLinks.map((link) => (
            <a
                href={link.href}
                target="_blank"
                rel="noopener noreferrer"
                class="flex h-12 w-12 items-center justify-center rounded-full bg-surface border border-border shadow-lg transition-transform duration-200 scale-75 focus-accent"
                aria-label={link.label}
                data-share-menu-item
            >
                <Icon name={link.icon} class="h-5 w-5 text-secondary" aria-hidden="true" />
            </a>
        ))}
        <button
            type="button"
            class="flex h-12 w-12 items-center justify-center rounded-full bg-surface border border-border shadow-lg transition-transform duration-200 scale-75 focus-accent"
            aria-label="复制链接"
            data-copy-link
            data-url={url}
            data-share-menu-item
        >
            <Icon name="ri:link" class="h-5 w-5 text-secondary" aria-hidden="true" />
        </button>
        <!-- 移动端点赞按钮 -->
        <button
            type="button"
            class="relative flex h-12 w-12 items-center justify-center rounded-full bg-surface border border-border shadow-lg transition-transform duration-200 scale-75 focus-accent group"
            aria-label="点赞"
            data-like-button
            data-slug={slug}
            data-share-menu-item
        >
            <Icon name="ri:heart-line" class="h-5 w-5 text-secondary group-data-[liked]:hidden" aria-hidden="true" />
            <Icon name="ri:heart-fill" class="h-5 w-5 hidden group-data-[liked]:block text-red-500" aria-hidden="true" />
            <span
                class="absolute -bottom-0.5 -right-0.5 min-w-4 h-4 flex items-center justify-center rounded-full bg-surface border border-border text-[10px] text-muted"
                data-like-count
            ></span>
        </button>
    </div>
</div>

<!-- Toast notification for copy success -->
<div
    data-copy-toast
    class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 flex items-center gap-2 rounded-lg bg-surface border border-border px-4 py-3 shadow-lg opacity-0 pointer-events-none transition-all duration-300 translate-y-2"
    role="status"
    aria-live="polite"
>
    <Icon name="ri:check-line" class="h-5 w-5 text-accent" aria-hidden="true" />
    <span class="text-sm text-primary">链接已复制</span>
</div>

<style>
    /* 点赞动画 */
    @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
    }
    .animate-pop { animation: pop 0.2s ease-out; }
    .animate-shake { animation: shake 0.3s ease-out; }

    /* 点满后的金色效果 */
    [data-like-button][data-max-reached] {
        border-color: #f59e0b !important;
    }
    [data-like-button][data-max-reached] svg {
        color: #f59e0b !important;
    }
</style>

<script is:inline>
(function() {
    const mobileToggle = document.querySelector("[data-share-mobile-toggle]");
    const shareMenu = document.querySelector("[data-share-menu]");
    const shareMenuItems = document.querySelectorAll("[data-share-menu-item]");
    const copyButtons = document.querySelectorAll("[data-copy-link]");
    const toast = document.querySelector("[data-copy-toast]");
    const likeButtons = document.querySelectorAll("[data-like-button]");
    const likeCountElements = document.querySelectorAll("[data-like-count]");

    let toastTimeout;
    let menuOpen = false;

    // Mobile menu toggle
    function setMenuOpen(open) {
        if (!shareMenu || !mobileToggle) return;
        menuOpen = open;
        mobileToggle.setAttribute("aria-expanded", String(open));
        shareMenu.setAttribute("aria-hidden", String(!open));

        if (open) {
            shareMenu.classList.remove("opacity-0", "pointer-events-none");
            shareMenuItems.forEach((item, i) => {
                setTimeout(() => {
                    item.classList.remove("scale-75");
                    item.classList.add("scale-100");
                }, i * 50);
            });
        } else {
            shareMenu.classList.add("opacity-0", "pointer-events-none");
            shareMenuItems.forEach((item) => {
                item.classList.remove("scale-100");
                item.classList.add("scale-75");
            });
        }
    }

    // Copy link to clipboard
    async function copyLink(url) {
        try {
            await navigator.clipboard.writeText(url);
            showToast();
        } catch (err) {
            // Fallback for older browsers
            const textarea = document.createElement("textarea");
            textarea.value = url;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            showToast();
        }
    }

    // Show toast notification
    function showToast() {
        if (!toast) return;
        clearTimeout(toastTimeout);
        toast.classList.remove("opacity-0", "pointer-events-none", "translate-y-2");
        toastTimeout = setTimeout(() => {
            toast.classList.add("opacity-0", "pointer-events-none", "translate-y-2");
        }, 2000);
    }

    // ============ 点赞功能（支持多次点赞，最多 16 次）============
    const LIKE_STORAGE_KEY = "bokushi_likes_v2";
    const MAX_LIKES = 16;

    // 获取 localStorage 中的点赞记录 { slug: userLikes }
    function getLikeData() {
        try {
            return JSON.parse(localStorage.getItem(LIKE_STORAGE_KEY) || "{}");
        } catch {
            return {};
        }
    }

    // 保存点赞记录到 localStorage
    function saveLikeData(data) {
        localStorage.setItem(LIKE_STORAGE_KEY, JSON.stringify(data));
    }

    // 更新所有点赞按钮的 UI
    function updateLikeUI(count, userLikes, maxReached) {
        likeButtons.forEach((btn) => {
            if (userLikes > 0) {
                btn.setAttribute("data-liked", "");
            } else {
                btn.removeAttribute("data-liked");
            }
            if (maxReached) {
                btn.setAttribute("data-max-reached", "");
            } else {
                btn.removeAttribute("data-max-reached");
            }
        });
        likeCountElements.forEach((el) => {
            el.textContent = count > 0 ? String(count) : "";
        });
    }

    // 获取点赞状态
    async function fetchLikeStatus(slug) {
        // 先用 localStorage 显示
        const localData = getLikeData();
        const localUserLikes = localData[slug] || 0;
        updateLikeUI(localUserLikes, localUserLikes, localUserLikes >= MAX_LIKES);

        try {
            const res = await fetch(`/api/like?slug=${encodeURIComponent(slug)}`);
            if (res.ok) {
                const data = await res.json();
                // 用服务端数据更新（更准确）
                const userLikes = Math.max(data.userLikes, localUserLikes);
                updateLikeUI(data.count, userLikes, userLikes >= MAX_LIKES);
                // 同步到 localStorage
                if (userLikes !== localUserLikes) {
                    localData[slug] = userLikes;
                    saveLikeData(localData);
                }
            }
        } catch (err) {
            console.error("Failed to fetch like status:", err);
        }
    }

    // 添加点赞（每次 +1）
    async function addLike(slug) {
        const localData = getLikeData();
        const currentLikes = localData[slug] || 0;

        // 已达上限
        if (currentLikes >= MAX_LIKES) {
            // 添加一个小动画提示已满
            likeButtons.forEach((btn) => {
                btn.classList.add("animate-shake");
                setTimeout(() => btn.classList.remove("animate-shake"), 300);
            });
            return;
        }

        // 乐观更新 UI
        const newLikes = currentLikes + 1;
        localData[slug] = newLikes;
        saveLikeData(localData);

        likeButtons.forEach((btn) => {
            btn.setAttribute("data-liked", "");
            // 点击动画
            btn.classList.add("animate-pop");
            setTimeout(() => btn.classList.remove("animate-pop"), 200);
        });

        try {
            const res = await fetch("/api/like", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ slug }),
            });
            if (res.ok) {
                const data = await res.json();
                updateLikeUI(data.count, data.userLikes, data.userLikes >= MAX_LIKES);
                // 同步 localStorage
                localData[slug] = data.userLikes;
                saveLikeData(localData);
            }
        } catch (err) {
            console.error("Failed to add like:", err);
        }
    }

    // Event listeners
    mobileToggle?.addEventListener("click", () => setMenuOpen(!menuOpen));

    // Close menu when clicking outside
    document.addEventListener("click", (e) => {
        if (menuOpen && !e.target.closest("[data-share-menu]") && !e.target.closest("[data-share-mobile-toggle]")) {
            setMenuOpen(false);
        }
    });

    // Close menu on escape
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && menuOpen) {
            setMenuOpen(false);
            mobileToggle?.focus();
        }
    });

    // Copy link buttons
    copyButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            const url = btn.dataset.url;
            if (url) copyLink(url);
            if (menuOpen) setMenuOpen(false);
        });
    });

    // Like buttons
    likeButtons.forEach((btn) => {
        const slug = btn.dataset.slug;
        if (slug) {
            btn.addEventListener("click", () => {
                addLike(slug);
                if (menuOpen) setMenuOpen(false);
            });
        }
    });

    // 页面加载时获取点赞状态
    const firstLikeButton = likeButtons[0];
    if (firstLikeButton) {
        const slug = firstLikeButton.dataset.slug;
        if (slug) {
            fetchLikeStatus(slug);
        }
    }
})();
</script>
