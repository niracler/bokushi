---
export interface Heading {
	depth: number;
	slug: string;
	text: string;
}

export interface Props {
	headings: Heading[];
}

const { headings } = Astro.props;

// 只显示 h2 和 h3，过滤掉 h1
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);

// 构建嵌套结构
interface NestedHeading extends Heading {
	children: NestedHeading[];
}

function buildNestedHeadings(headings: Heading[]): NestedHeading[] {
	const nested: NestedHeading[] = [];
	const stack: NestedHeading[] = [];

	headings.forEach((heading) => {
		const node: NestedHeading = { ...heading, children: [] };

		// 找到合适的父节点
		while (stack.length > 0 && stack[stack.length - 1].depth >= node.depth) {
			stack.pop();
		}

		if (stack.length === 0) {
			nested.push(node);
		} else {
			stack[stack.length - 1].children.push(node);
		}

		stack.push(node);
	});

	return nested;
}

const nestedHeadings = buildNestedHeadings(filteredHeadings);
---

{nestedHeadings.length > 0 && (
	<nav class="toc" data-no-preview aria-label="Table of Contents">
		<h2 class="toc-title">目录</h2>
		<ol class="toc-list">
			{nestedHeadings.map((heading, index) => (
				<li>
					<a
						href={`#${heading.slug}`}
						data-toc-link
						data-heading-id={heading.slug}
						class="toc-link"
					>
						<span class="toc-number">{index + 1}</span>
						<span class="toc-text">{heading.text}</span>
					</a>
					{heading.children.length > 0 && (
						<ol class="toc-sublist">
							{heading.children.map((child, childIndex) => (
								<li>
									<a
										href={`#${child.slug}`}
										data-toc-link
										data-heading-id={child.slug}
										class="toc-link toc-link-child"
									>
										<span class="toc-number">{index + 1}.{childIndex + 1}</span>
										<span class="toc-text">{child.text}</span>
									</a>
								</li>
							))}
						</ol>
					)}
				</li>
			))}
		</ol>
	</nav>
)}

<style>
	.toc {
		position: sticky;
		top: 2rem;
		max-height: calc(100vh - 4rem);
		overflow-y: auto;
		padding: 0;
	}

	.toc-title {
		margin: 0 0 1rem 0;
		font-size: 0.875rem;
		font-weight: 600;
		color: var(--color-text-muted);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.toc-list,
	.toc-sublist {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.toc-list > li {
		margin-bottom: 0.5rem;
	}

	.toc-sublist {
		margin-top: 0.375rem;
		margin-left: 0.75rem;
		border-left: 1px solid color-mix(in srgb, var(--color-border-subtle) 50%, transparent);
		padding-left: 0.75rem;
	}

	.toc-sublist > li {
		margin-bottom: 0.375rem;
	}

	.toc-link {
		display: grid;
		grid-template-columns: auto 1fr;
		gap: 0.375rem;
		align-items: start;
		color: var(--color-text-muted);
		text-decoration: none;
		font-size: 0.8125rem;
		line-height: 1.6;
		transition: all 0.2s ease;
		position: relative;
		padding: 0.125rem 0;
	}

	.toc-number {
		font-size: 0.6875rem;
		font-weight: 500;
		font-variant-numeric: tabular-nums;
		color: color-mix(in srgb, var(--color-text-muted) 50%, transparent);
		user-select: none;
		padding-top: 0.05rem;
	}

	.toc-text {
		min-width: 0;
		word-break: break-word;
	}

	.toc-link:hover {
		color: var(--color-text-secondary);
	}

	.toc-link:hover .toc-number {
		color: color-mix(in srgb, var(--color-text-muted) 70%, transparent);
	}

	.toc-link.active {
		color: var(--color-accent);
		font-weight: 600;
	}

	.toc-link.active .toc-number {
		color: var(--color-accent);
		font-weight: 600;
	}

/* 取消左侧橙色竖条，仅使用加粗与颜色强调 */
	.toc-link.active::before { content: none; }
	.toc-link-child.active::before { content: none; }

	/* 自定义滚动条 */
	.toc::-webkit-scrollbar {
		width: 4px;
	}

	.toc::-webkit-scrollbar-track {
		background: transparent;
	}

	.toc::-webkit-scrollbar-thumb {
		background: color-mix(in srgb, var(--color-border-subtle) 60%, transparent);
		border-radius: 2px;
	}

	.toc::-webkit-scrollbar-thumb:hover {
		background: var(--color-border-subtle);
	}
</style>
