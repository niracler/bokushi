---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';

const blogPosts = await getCollection('blog');
const monthlyPosts = await getCollection('monthly');
const tilPosts = await getCollection('til');
const posts = [...blogPosts, ...monthlyPosts, ...tilPosts];
const tagCountMap = new Map<string, number>();

posts.forEach((post) => {
	(post.data.tags || []).forEach((tag) => {
		if (!tag) return;
		tagCountMap.set(tag, (tagCountMap.get(tag) ?? 0) + 1);
	});
});

const sortedTags = Array.from(tagCountMap.entries())
	.sort((a, b) => {
		if (b[1] === a[1]) {
			return a[0].localeCompare(b[0], 'zh-Hans-u-nu-latn');
		}
		return b[1] - a[1];
	});

const primaryTags = sortedTags.filter(([_, count]) => count >= 3);
const secondaryTags = sortedTags.filter(([_, count]) => count < 3);

const pageTitle = "标签索引";
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`${pageTitle} | ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="mx-auto max-w-4xl space-y-12 px-4">
			<header class="space-y-3 text-center">
				<h1 class="text-3xl font-semibold tracking-tight text-[var(--color-text-primary)] sm:text-4xl">{pageTitle}</h1>
				<p class="text-sm uppercase tracking-[0.25em] text-[color-mix(in srgb, var(--color-text-muted) 70%, transparent)]">
					从这里探索所有话题
				</p>
			</header>
			<section class="space-y-8">
				{primaryTags.length > 0 && (
					<div class="space-y-3">
						<h2 class="text-center text-xs font-semibold uppercase tracking-[0.38em] text-[color-mix(in srgb, var(--color-text-muted) 70%, transparent)]">
							高频标签
						</h2>
						<div class="flex flex-wrap justify-center gap-3 sm:gap-4">
							{primaryTags.map(([tag, count]) => (
								<p class="m-0">
									<a
										href={`/tags/${tag}`}
										class="inline-flex items-center rounded-full border border-border-subtle bg-[var(--color-bg-surface)] px-4 py-2 text-sm font-medium text-[var(--color-text-secondary)] transition-colors hover:border-[var(--color-accent)] hover:bg-[var(--color-accent-soft)] hover:text-[var(--color-accent)]"
									>
										<span>{tag}</span>
										<span class="ml-2 text-xs font-semibold text-[var(--color-text-muted)]">
											{count}
										</span>
									</a>
								</p>
							))}
						</div>
					</div>
				)}

				{secondaryTags.length > 0 && (
					<div class="space-y-3">
						<h2 class="text-center text-xs font-semibold uppercase tracking-[0.38em] text-[color-mix(in srgb, var(--color-text-muted) 70%, transparent)]">
							其余标签
						</h2>
						<div class="flex flex-wrap justify-center gap-3 sm:gap-4">
							{secondaryTags.map(([tag, count]) => (
								<p class="m-0">
									<a
										href={`/tags/${tag}`}
										class="inline-flex items-center rounded-full border border-border-subtle bg-[var(--color-bg-surface)] px-4 py-2 text-sm font-medium text-[var(--color-text-secondary)] transition-colors hover:border-[var(--color-accent)] hover:bg-[var(--color-accent-soft)] hover:text-[var(--color-accent)]"
									>
									<span>{tag}</span>
									<span class="ml-2 text-[0.75rem] font-semibold text-[color-mix(in srgb, var(--color-text-muted) 65%, transparent)]">
										{count}
									</span>
									</a>
								</p>
							))}
						</div>
					</div>
				)}
			</section>
		</main>
		<Footer />
	</body>
</html>
