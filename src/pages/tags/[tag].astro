---
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Header from "../../components/Header.astro";
import { SITE_TITLE } from "../../consts";

export const prerender = true;

export async function getStaticPaths() {
    const blogPosts = await getCollection("blog");
    const monthlyPosts = await getCollection("monthly");
    const tilPosts = await getCollection("til");
    const allPosts = [...blogPosts, ...monthlyPosts, ...tilPosts].filter(
        (post) => !post.data.hidden,
    );
    const uniqueTags = [...new Set(allPosts.flatMap((post) => post.data.tags || []))];

    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts.filter((post) => (post.data.tags || []).includes(tag));
        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const sortedPosts = posts
    .filter((post) => !post.data.hidden)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead
			title={`标签: ${tag} | ${SITE_TITLE}`}
			description={`所有标记为 "${tag}" 的文章`}
		/>
	</head>
	<body>
		<Header />
		<main class="mx-auto max-w-4xl space-y-10 px-4">
			<nav class="text-sm text-secondary">
				<a
					href="/tags"
					class="inline-flex items-center gap-2 transition hover:text-accent"
				>
					<span aria-hidden="true">←</span> 返回标签索引
				</a>
			</nav>
			<header class="space-y-2">
				<p
					class="text-xs uppercase tracking-[0.28em] text-[color-mix(in_srgb,var(--color-text-muted)_70%,transparent)]"
				>
					Tag
				</p>
				<h1
					class="text-3xl font-semibold tracking-tight text-primary sm:text-4xl"
				>
					<span class="text-accent">{tag}</span>
				</h1>
			</header>
			<section>
				<ul class="m-0 flex list-none flex-col gap-3.5 p-0 sm:gap-4">
					{
						sortedPosts.map((post) => (
							<li>
								<div class="group flex items-baseline gap-4 px-3 py-2 transition duration-150 sm:px-4 sm:py-2.5">
									<h4 class="flex-1 text-base font-semibold tracking-tight text-primary transition duration-150 group-hover:text-accent sm:text-lg">
										<a
											href={`/${post.id}`}
											class="no-underline text-primary transition hover:text-accent focus-visible:outline-none focus-visible:text-accent focus-visible:underline"
											data-post-id={post.id}
										>
											{post.data.title}
										</a>
									</h4>
									<p
										class="ml-auto flex items-center gap-2 text-[0.7rem] uppercase tracking-[0.14em] text-[color-mix(in_srgb,var(--color-text-muted)_75%,transparent)] transition-colors group-hover:text-accent sm:text-xs"
										data-no-preview
									>
										<span
											aria-hidden="true"
											class="hidden h-px w-6 bg-[color-mix(in_srgb,var(--color-text-muted)_50%,transparent)] sm:inline-block"
										/>
										<FormattedDate
											date={post.data.pubDate}
										/>
									</p>
								</div>
							</li>
						))
					}
				</ul>
			</section>
		</main>
		<Footer />
	</body>
</html>
