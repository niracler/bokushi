---
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes breathe {
        0%,
        100% {
          opacity: 0.95;
        }
        50% {
          opacity: 1;
        }
      }

      .quote-container {
        animation: fadeIn 1s ease-out;
        position: relative;
        width: 100%;
      }

      .quote-text {
        color: var(--color-text-secondary);
        line-height: 1.8;
        font-size: clamp(1.25rem, 4.5vw, 1.5rem);
      }

      /* 幽灵容器保持高度稳定 */
      .quote-ghost {
        visibility: hidden;
        pointer-events: none;
        user-select: none;
        aria-hidden: true;
      }

      /* 真实打字机覆盖在幽灵容器上 */
      .quote-actual {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        margin: 0 auto;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .quote-actual.is-ready {
        opacity: 1;
      }

      .quote-emphasis {
        display: inline-block;
        font-size: clamp(1.75rem, 6.5vw, 2.25rem); /* 提升最小字号 */
        font-weight: 700;
        letter-spacing: 0.1em;
        color: var(--color-link);
        margin: clamp(0.75rem, 2.5vw, 1rem) 0;
        animation: breathe 4s ease-in-out infinite;
      }

      .quote-source {
        transition: all 0.5s ease;
        opacity: 0; /* 初始隐藏，由脚本控制显现 */
      }

      .quote-source.is-visible {
        opacity: 1;
      }

      @media (prefers-reduced-motion: reduce) {
        .quote-container,
        .quote-source {
          animation: none;
        }
        .quote-emphasis {
          animation: none;
        }
      }

      .quote-source:hover {
        transform: translateX(-8px);
      }

      .quote-source a {
        position: relative;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .quote-source a::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 0;
        height: 2px;
        background: var(--color-accent);
        transition: width 0.3s ease;
      }

      .quote-source a:hover::after {
        width: 100%;
      }

      /* Typewriter cursor style */
      .typewriter-cursor {
        display: inline-block;
        width: 1.5px;
        height: 1.2em;
        background-color: var(--color-accent);
        margin-left: 2px;
        animation: blink 0.75s step-end infinite;
        vertical-align: middle;
        position: relative;
        top: -0.05em;
      }

      @keyframes blink {
        50% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <Header />
    <main
      class="page-shell flex min-h-[calc(100vh-18rem)] items-center justify-center"
    >
      <section
        class="quote-container mx-auto max-w-3xl space-y-6 sm:space-y-8 text-center px-4"
      >
        <!-- 幽灵占位符：用于提前撑开高度并固定垂直中心点 -->
        <blockquote
          class="quote-text quote-ghost space-y-4 sm:space-y-6 leading-relaxed"
        >
          <p>
            <span class="block sm:inline">或许每个人都在证明自己的存在，</span>
            <span class="block sm:inline">渴望被他人感知。</span>
          </p>
          <p>
            <span class="block sm:inline">一切行为的背后，</span>
            <span class="block sm:inline">只有一个简洁却悲痛的讯息：</span>
          </p>
          <p class="quote-emphasis">「不要忘了我」。</p>
        </blockquote>

        <!-- 真实显示并打字的 Blockquote -->
        <blockquote
          class="quote-text quote-actual space-y-4 sm:space-y-6 leading-relaxed"
          id="typewriter-quote"
        >
          <p>
            <span class="block sm:inline">或许每个人都在证明自己的存在，</span>
            <span class="block sm:inline">渴望被他人感知。</span>
          </p>
          <p>
            <span class="block sm:inline">一切行为的背后，</span>
            <span class="block sm:inline">只有一个简洁却悲痛的讯息：</span>
          </p>
          <p class="quote-emphasis">「不要忘了我」。</p>
        </blockquote>
        <p
          class="quote-source text-right text-base text-muted"
          id="quote-source"
        >
          —— 《<a
            href="https://t.me/tomoko_channel/7"
            class="text-secondary hover:text-accent">凉宫春日的忧郁</a
          >》
        </p>
      </section>
    </main>
    <Footer />
    <script>
      interface TypeTask {
        node: Node;
        text: string;
        parent: HTMLElement;
      }

      const quoteElement = document.getElementById("typewriter-quote");
      const sourceElement = document.getElementById("quote-source");

      if (quoteElement && sourceElement) {
        const tasks: TypeTask[] = [];
        const walker = document.createTreeWalker(
          quoteElement,
          NodeFilter.SHOW_TEXT,
          null
        );

        const cursor = document.createElement("span");
        cursor.className = "typewriter-cursor";

        let node: Node | null;
        while ((node = walker.nextNode())) {
          if (node.parentNode instanceof HTMLElement) {
            tasks.push({
              node: node,
              text: node.nodeValue || "",
              parent: node.parentNode,
            });
            node.nodeValue = "\u200B"; // 使用零宽空格占位
          }
        }

        // 初始化准备就绪，显示语录
        quoteElement.classList.add("is-ready");

        let currentTaskIndex = 0;
        let currentCharIndex = 0;

        const type = () => {
          if (currentTaskIndex < tasks.length) {
            const { node, text, parent } = tasks[currentTaskIndex];

            if (currentCharIndex < text.length) {
              const char = text.charAt(currentCharIndex);

              if (node.nodeValue === "\u200B") {
                node.nodeValue = "";
                parent.appendChild(cursor);
              }

              node.nodeValue += char;
              (node as unknown as ChildNode).after(cursor);
              currentCharIndex++;

              // 业界级“流式自然”节奏
              let delay = 60 + Math.random() * 15; // 稳定流速 (35ms-50ms)

              // 重点词一字一顿策略
              if (text.includes("不要忘了我")) {
                delay = 80; // 稳定且略慢，增加郑重感
              }

              // 逻辑语义停顿 (极其短促，保持心流)
              if (char === "，" || char === "：") {
                delay = 120;
              } else if (char === "。" || char === "！" || char === "？") {
                delay = 250;
              }

              setTimeout(type, delay);
            } else {
              currentTaskIndex++;
              currentCharIndex = 0;
              setTimeout(type, 100); // 极短行间过渡
            }
          } else if (sourceElement) {
            cursor.remove();
            sourceElement.classList.add("is-visible");
          }
        };

        // 适中启动速度
        setTimeout(type, 600);
      }
    </script>
  </body>
</html>
